name: Build OpenWrt (MX4200 v1 & v2)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        device: [mx4200v1, mx4200v2]
    name: Build OpenWrt ${{ matrix.device }}

    outputs:
      version: ${{ steps.upload-firmware.outputs.version }}
      device: ${{ matrix.device }}
      result: ${{ job.status }}

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v3

    - name: Set up build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          gcc g++ gcc-multilib g++-multilib \
          flex bison clang gawk gettext git \
          libncurses-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file libelf-dev libc6-dev \
          libtool autoconf automake cmake pkg-config libglib2.0-dev
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        echo "LD=ld" >> $GITHUB_ENV

    - name: Checkout OpenWrt buildroot
      uses: actions/checkout@v4
      with:
        repository: qosmio/openwrt-ipq
        path: openwrt
        fetch-depth: 0   # full history, keeps proper rXXXXX version

    - name: Apply custom config and files
      run: |
        cd openwrt/package

        # Clone custom packages
        git clone https://github.com/gSpotx2f/luci-app-interfaces-statistics.git
        git clone https://github.com/jerrykuku/luci-theme-argon.git
        git clone https://github.com/jerrykuku/luci-app-argon-config.git
        git clone https://github.com/gSpotx2f/luci-app-cpu-status.git

        cd ..

        ./scripts/feeds update -a
        ./scripts/feeds install -a

        # Add custom files if available
        if [ -d ../custom/files ]; then
          cp -a ../custom/files/. files/
          if [ -d files/etc/profile.d ]; then
            chmod -R +x files/etc/profile.d/
          fi
        fi

        # Apply patches if any
        if [ -d ../custom/patches ]; then
          for patch in ../custom/patches/*.patch; do
            [ -f "$patch" ] && patch -p1 < "$patch"
          done
        fi

        # Use the right config.seed for the current matrix device
        cp ../config.${{ matrix.device }}.seed .config

    - name: Build firmware
      run: |
        cd openwrt
        make defconfig
        make download -j$(nproc)
        make -j$(nproc)

    - name: Upload firmware to Cloudflare R2
      id: upload-firmware
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        R2_BUCKET: openwrt
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
      run: |
        cd openwrt/bin/targets
        TARGET_DIR=$(find . -type f -name version.buildinfo -exec dirname {} \;)
        cd "$TARGET_DIR"
        VERSION=$(cat version.buildinfo | tr -d '\n')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Uploaded version $VERSION for ${{ matrix.device }}"

        sync
        sha256sum -c sha256sums

        for file in openwrt-qualcommax-ipq807x-linksys_${{ matrix.device }}*; do
          if [[ -f "$file" ]]; then
            if [[ "$file" == *.manifest ]]; then
              newfile="manifest"
            else
              newfile="${file#openwrt-qualcommax-ipq807x-linksys_${{ matrix.device }}-}"
            fi
            mv "$file" "$newfile"
          fi
        done

        aws --endpoint-url "$R2_ENDPOINT" s3 cp . "s3://$R2_BUCKET/${{ matrix.device }}/$VERSION/" --recursive --exclude "packages/*"

  notify:
    runs-on: ubuntu-22.04
    needs: build
    if: always()
    steps:
    - name: Collect results and notify Discord
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        R2_BUCKET: openwrt
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
      run: |
        summary=""
        failures=()

        # Extract outputs from all matrix builds
        jq -r 'to_entries[] | "\(.value.outputs.device) \(.value.outputs.version) \(.value.result)"' <<< '${{ toJSON(needs.build) }}' > results.txt

        while read -r device version result; do
          if [ "$result" = "success" ]; then
            url="https://${R2_BUCKET}.${R2_ENDPOINT#https://}/${device}/${version}/"
            summary="$summary\n✅ **$device** built successfully (version: $version)\n<${url}>"
          else
            summary="$summary\n❌ **$device** failed to build"
            failures+=("$device")
          fi
        done < results.txt

        if [ ${#failures[@]} -eq 0 ]; then
          content="# ✅ OpenWrt build succeeded!\n$summary"
        else
          content="# ❌ OpenWrt build failed!\n$summary"
        fi

        curl -H "Content-Type: application/json" -X POST \
          -d "{\"content\": \"$content\"}" \
          $DISCORD_WEBHOOK_URL
